# Model Data Pipeline - Pidgin Implementation

## Overview
How Pidgin consumes model configuration data generated by the `pidgin-tools` repository.

## Architecture

### Data Flow
```
[pidgin-tools repo]              [Pidgin Package]           [User Runtime]
generates models.json → copied to pidgin/data/ → installed → can be overridden
                                                            at ~/.local/share/pidgin/
```

### Loading Priority
```python
1. ~/.local/share/pidgin/models.json  # User customizations (highest priority)
2. ./pidgin/data/models.json          # Package data (fallback)
3. Minimal hardcoded fallback         # Emergency only (test/silent models)
```

## XDG Directory Usage

According to XDG Base Directory spec:
- `~/.local/share/pidgin/` - User's model customizations (persistent data)
- `~/.cache/pidgin/` - Cached API responses, temporary data
- `~/.config/pidgin/` - Configuration files (already in use)

The `~/.local/share/` location is correct for user-modified model data that should persist across updates.

## Current Implementation

### Model Loading (`pidgin/config/model_loader.py`)

The ModelLoader class handles:
- Loading from user override or package data
- Schema version validation with migration support
- Case-insensitive alias resolution
- Fallback to minimal test/silent models if no JSON found

### Key Features

1. **Schema Versioning**: Supports migration between schema versions
2. **Case-Insensitive Resolution**: User can type `Claude`, `claude`, or `CLAUDE`
3. **Clean Fallback**: Returns minimal test/silent models if no data available
4. **Full Override**: User's `models.json` completely replaces package data

### Future: Partial Override Support

If users request it, we could support `model_overrides.json` for partial changes:
- Add specific models
- Update pricing for existing models
- Remove unwanted models
- Add custom aliases

Currently using full replacement for simplicity.

## Update Process

1. **pidgin-tools repo** runs monthly GitHub Action
2. Fetches latest from OpenRouter API (no auth needed)
3. Adds hardcoded Ollama models (qwen, phi, mistral)
4. Transforms data to match schema
5. Creates PR or issue for review
6. Human reviews changes
7. Merge updates `pidgin-tools/output/models.json`
8. Copy to `pidgin/data/models.json` before release

### Ollama Models Integration

The `pidgin-tools` repo includes hardcoded definitions for popular Ollama models:

**Practical Models:**
- **local:qwen** - Qwen 0.5B (500MB, fast)
- **local:phi** - Phi-3 (2.8GB, balanced)
- **local:mistral** - Mistral 7B (4.1GB, needs 8GB+ RAM)

**GPT-OSS Models (Experimental):**
- **local:gpt-oss-9b** - GPT-OSS 9B (~5GB, needs 16GB+ RAM)
- **local:gpt-oss-26b** - GPT-OSS 26B (~15GB, needs 32GB+ RAM)
- **local:gpt-oss-120b** - GPT-OSS 120B (~70GB, needs 128GB+ RAM) ⚠️

These are included in the generated `models.json` with metadata:
- Size information (for display)
- Actual Ollama model names (e.g., `qwen2.5:0.5b`, `gpt-oss:9b`)
- Context window sizes
- RAM requirements (with warnings for large models)


## CLI Integration

The `pidgin models` command:
- Shows curated models by default
- `--all` flag shows all available models
- `--show-aliases` displays alias mappings
- Reads from loaded JSON data via ModelLoader
- Dynamically detects installed Ollama models
- Shows Ollama models from JSON even if not installed

### Ollama Auto-Start Configuration

For security, Ollama server auto-start is controlled by:
1. Config file: `~/.config/pidgin/config.yaml` with `ollama.auto_start: true`
2. Environment variable: `PIDGIN_OLLAMA_AUTO_START=true`
3. Interactive prompt (default if not configured)

This ensures explicit consent while allowing scriptability for CI/CD workflows.

## Benefits

1. **Clean separation** - Generation in `pidgin-tools`, consumption in `pidgin`
2. **User control** - Full override via `~/.local/share/pidgin/models.json`
3. **Automated updates** - Monthly checks with human review
4. **Versioned schema** - Future-proof with migration support
5. **Case-insensitive** - Better UX for model selection
6. **XDG compliant** - Proper directory usage

## Implementation Status

- ✅ ModelLoader with JSON support (`pidgin/config/model_loader.py`)
- ✅ Schema definition (`pidgin/data/models_schema.json`)
- ✅ Case-insensitive alias resolution
- ✅ Fallback to test/silent models
- ✅ Placeholder models.json created (`pidgin/data/models.json`)
- ✅ Provider module imports removed - JSON only
- ✅ Python 3.13 support added
- ⏳ Full models.json to be generated by pidgin-tools
- ⏳ User override documentation
- ⏳ Monthly update automation in pidgin-tools repo